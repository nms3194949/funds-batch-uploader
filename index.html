<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8">
<title>æ›´æ–°åŸºé‡‘è³‡æ–™åº«</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<style>
:root {
  --deep: #0A1221;
  --gold: #C9A227;
  --gold-grad: linear-gradient(180deg, #EFD88A 0%, #C9A227 50%, #B8860B 100%);
  --muted: #9fb1cc;
  --error-bg: #401A1A;
  --error-text: #FFDADA;
}
*{box-sizing:border-box}
body { background: var(--deep); color: #EDEFF5; font-family: system-ui, "Noto Sans TC", sans-serif; padding: 24px; line-height: 1.6; }
h2 { font-size: 26px; font-weight: 800; background: var(--gold-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 12px; }
label { display:block; margin-top:12px; font-weight:600; color:var(--muted); }
input, button, textarea { border-radius: 10px; border: 1px solid #22304a; background: #0f1626; color: #EDEFF5; }
input, textarea { padding: 8px; }
button { padding: 10px 18px; font-weight: 700; border: none; background: var(--gold-grad); color: #05122b; cursor: pointer; transition: 0.3s; box-shadow: 0 3px 6px rgba(0,0,0,.3); }
button:hover { filter: brightness(1.1); transform: translateY(-1px); } button:active { transform: translateY(0); }
#indicator { display:inline-block; margin-left:10px; font-size:20px; vertical-align:middle; }
pre { white-space: pre-wrap; background:#111827; padding:12px; border-radius:8px; margin-top:16px; color:#B2F5EA; font-size:13px; }
#errorList { margin-top:16px; background:var(--error-bg); color:var(--error-text); padding:12px; border-radius:8px; display:none; }
.mode-wrap { margin: 10px 0 6px; }
.segs { display:inline-flex; gap:8px; padding:4px; background:#0f1626; border:1px solid #22304a; border-radius:12px; }
.segs label { margin:0; padding:8px 12px; border-radius:10px; cursor:pointer; color:#EDEFF5; border:1px solid transparent; user-select:none; }
.segs input { display:none; }
.segs input:checked + span { background: var(--gold-grad); color:#05122b; font-weight:800; border-color:transparent; box-shadow: 0 2px 6px rgba(0,0,0,.35) inset; }
.small { color: var(--muted); font-size: 12px; }
.row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
</style>

<body>
<h2>æ›´æ–°åŸºé‡‘è³‡æ–™åº«ï¼ˆä¾ä»£ç¢¼è¦†å¯« 3m/6m/1Y/2Y/3Y/5Y + é¢¨éšªæŒ‡æ¨™ï¼‰</h2>

<p>ä¸Šå‚³ç¾æœ‰ <b>åŸºé‡‘è³‡æ–™åº«.xlsx</b> â†’ è‡ªå‹•æŠ“å–æ›´æ–°ï¼ˆè¦†å¯«åŒä»£ç¢¼åŸºé‡‘ï¼‰ã€‚<br>
å€¼å¯«å…¥è¦å‰‡ï¼š<b>æ‰€æœ‰å ±é…¬èˆ‡ã€Œå¹´åŒ–æ¨™æº–å·®%ã€ä¸åšä»»ä½•é‹ç®—ï¼Œåƒ…å°‡æŠ“å–å€¼ç›´æ¥åŠ ä¸Šã€Œ%ã€å­—ä¸²</b>ï¼›è‹¥åŸå€¼å·²å« %ï¼ˆå…¨å½¢ï¼…æˆ–åŠå½¢% çš†å¯ï¼‰ï¼Œå‰‡ç¶­æŒä¸è®Šã€‚<br>
<span class="small">ç¶­æŒï¼š<b>Sharpe</b>ã€<b>Beta</b> ä»¥ç´”æ•¸å­—å¯«å…¥ï¼ˆä¸åŠ  %ï¼‰ã€‚åŒæ™‚æ”¯æ´ <b>è¿‘3æœˆ%(ç¶²é )</b>ã€<b>è¿‘6æœˆ%(ç¶²é )</b> æ¬„ä½ã€‚</span></p>

<label>æ‰¹æ¬¡ API Endpoint</label>
<input id="ep" style="width:800px"
 value="https://momo-fund-worker.nms3194949.workers.dev/api/funds/batch">

<label>Apps Script ä¸Šå‚³ç¶²å€</label>
<input id="uploadUrl" style="width:800px"
 value="https://script.google.com/macros/s/AKfycbx6P7zOVtOsM6BUOb1WBbO455i1hUIns_qp65WWwzZ08ohlDsa9WPhxkAa99eseymua/exec">

<div class="mode-wrap">
  <label style="margin-bottom:6px">æ›´æ–°å®Œæˆå¾Œçš„å‹•ä½œ</label>
  <div class="segs" id="modeSegs">
    <label><input type="radio" name="afterMode" value="upload" id="mUpload" checked><span>è‡ªå‹•ä¸Šå‚³åˆ°é›²ç«¯</span></label>
    <label><input type="radio" name="afterMode" value="download" id="mDownload"><span>ä¸‹è¼‰æ›´æ–°å¾Œ Excel</span></label>
  </div>
</div>

<div class="row">
  <input id="file" type="file" accept=".xlsx,.xls">
  <span id="info" style="color:var(--muted)"></span>
</div>
<br>

<button id="start">é–‹å§‹æŠ“å–ä¸¦æ›´æ–°</button>
<span id="indicator">âš«</span>
<span id="status" style="margin-left:10px;color:var(--muted)"></span>

<pre id="out"></pre>
<div id="errorList"><b>âš ï¸ éŒ¯èª¤æ¸…å–®ï¼š</b><br><div id="errItems"></div></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
const fileEl = document.getElementById('file');
const infoEl = document.getElementById('info');
const startBtn = document.getElementById('start');
const out = document.getElementById('out');
const statusEl = document.getElementById('status');
const indicator = document.getElementById('indicator');
const errorBox = document.getElementById('errorList');
const errItems = document.getElementById('errItems');
const ep = document.getElementById('ep');
const uploadUrlEl = document.getElementById('uploadUrl');
const modeSegs = document.getElementById('modeSegs');

let workbook, targetSheetName;

/* ========== è¨˜ä½é¸é … ========== */
const LS = { ep:'cfg_ep', upload:'cfg_upload', mode:'cfg_mode' };
[[ep,LS.ep],[uploadUrlEl,LS.upload]].forEach(([el,key])=>{
  const v = localStorage.getItem(key); if (v) el.value = v;
  el.addEventListener('change',()=>localStorage.setItem(key, el.value||''));
});
modeSegs.addEventListener('change',()=>localStorage.setItem(LS.mode,getMode()));
if (localStorage.getItem(LS.mode)==='download') document.getElementById('mDownload').checked=true;

fileEl.addEventListener('change', async (e) => {
  const f = e.target.files[0];
  if (!f) return;
  infoEl.textContent = `å·²é¸æ“‡ï¼š${f.name}ï¼ˆ${(f.size/1024).toFixed(1)} KBï¼‰`;
  const data = await f.arrayBuffer();
  workbook = XLSX.read(data, { type: 'array' });
  targetSheetName = workbook.SheetNames[0];
});

function getMode(){ return (document.querySelector('input[name="afterMode"]:checked')?.value)||'upload'; }

/* ========== è¡¨é ­åµæ¸¬ï¼šå½ˆæ€§åˆ¥å + å¤šåˆ—æƒæ ========== */
const COL_HEADERS = {
  code: ['åŸºé‡‘ä»£ç¢¼','ä»£ç¢¼','code'],
  y1:   ['è¿‘1å¹´%','è¿‘ä¸€å¹´%','1å¹´%','ä¸€å¹´%','1y','1Y','è¿‘1å¹´ï¼…'],
  y3:   ['è¿‘3å¹´%','è¿‘ä¸‰å¹´%','3å¹´%','ä¸‰å¹´%','3y','3Y','è¿‘3å¹´ï¼…','è¿‘3å¹´ç´¯ç©%','è¿‘ä¸‰å¹´ç´¯ç©%'],
  y5:   ['è¿‘5å¹´%','è¿‘äº”å¹´%','5å¹´%','äº”å¹´%','5y','5Y','è¿‘5å¹´ï¼…','è¿‘5å¹´ç´¯ç©%','è¿‘äº”å¹´ç´¯ç©%'],
  m3:   ['è¿‘3æœˆ%','ä¸‰å€‹æœˆ%','3æœˆ%','è¿‘ä¸‰å€‹æœˆ%','3m','3M','è¿‘3æœˆï¼…'],
  m6:   ['è¿‘6æœˆ%','å…­å€‹æœˆ%','6æœˆ%','è¿‘å…­å€‹æœˆ%','6m','6M','è¿‘6æœˆï¼…'],
  y2:   ['è¿‘2å¹´%','äºŒå¹´%','2å¹´%','è¿‘å…©å¹´%','2y','2Y','è¿‘2å¹´ï¼…'],

  // æ–°å¢ï¼šç¶²é  3m/6m + é¢¨éšªæŒ‡æ¨™ï¼ˆå«æ‹¬è™Ÿè®Šé«”ï¼‰
  m3w:  ['è¿‘3æœˆ%(ç¶²é )','3m(web)','3m_web','3m(ç¶²é )','3m(ç¶²ç«™)'],
  m6w:  ['è¿‘6æœˆ%(ç¶²é )','6m(web)','6m_web','6m(ç¶²é )','6m(ç¶²ç«™)'],
  std:  ['å¹´åŒ–æ¨™æº–å·®%','å¹´åŒ–æ¨™æº–å·®(%)','stdev%','stddev%','stddev_annual%','annualized stdev%'],
  sharpe:['Sharpe','å¤æ™®å€¼','å¤æ™®'],
  beta: ['Beta','è²ä»–','Î²']
};
// æ›´å¼·åŒ–çš„æ¨™é ­æ­£è¦åŒ–ï¼šå»ç©ºç™½ã€å…¨å½¢ï¼…â†’åŠå½¢%ã€å»æ‹¬è™Ÿèˆ‡é€—è™Ÿ
const NORM = s => String(s||'')
  .replace(/\s+/g,'')
  .replace(/ï¼…/g,'%')
  .replace(/[()ï¼ˆï¼‰,ï¼Œ]/g,'')
  .toLowerCase();

// å…ˆåš´æ ¼æ¯”å°ï¼›è‹¥ missï¼Œå†ç”¨ã€ŒåŒ…å«å¼ã€å‚™æ´ï¼ˆé¿å…å¾®å·®å­—æ¨£ã€æ‹¬è™Ÿç­‰ï¼‰
function findHeaderIndex(headers, aliases){
  const normAliases = aliases.map(NORM);
  // 1) ç²¾ç¢ºå‘½ä¸­
  for (let i=0;i<headers.length;i++){
    const h = NORM(headers[i]);
    if (normAliases.includes(h)) return i;
  }
  // 2) åŒ…å«å¼ï¼ˆä¾‹å¦‚ã€Œå¹´åŒ– æ¨™æº–å·®(%)ã€åŒ…å«ã€Œå¹´åŒ–æ¨™æº–å·®%ã€ï¼‰
  for (let i=0;i<headers.length;i++){
    const h = NORM(headers[i]);
    if (normAliases.some(a => h.includes(a))) return i;
  }
  return -1;
}

function detectHeaderRow(aoa, maxScan=15){
  for (let r=0; r<Math.min(maxScan, aoa.length); r++){
    const row = aoa[r] || [];
    const code = findHeaderIndex(row, COL_HEADERS.code);
    const y1   = findHeaderIndex(row, COL_HEADERS.y1);
    const y3   = findHeaderIndex(row, COL_HEADERS.y3);
    const y5   = findHeaderIndex(row, COL_HEADERS.y5);
    if (code>=0 && (y1>=0 || y3>=0 || y5>=0)) {
      const map = {
        code, y1, y3, y5,
        m3: findHeaderIndex(row, COL_HEADERS.m3),
        m6: findHeaderIndex(row, COL_HEADERS.m6),
        y2: findHeaderIndex(row, COL_HEADERS.y2),
        m3w:findHeaderIndex(row, COL_HEADERS.m3w),
        m6w:findHeaderIndex(row, COL_HEADERS.m6w),
        std:findHeaderIndex(row, COL_HEADERS.std),
        sharpe:findHeaderIndex(row, COL_HEADERS.sharpe),
        beta:findHeaderIndex(row, COL_HEADERS.beta)
      };
      return { r, map, headers: row };
    }
  }
  return null;
}

/* ========== ç™¾åˆ†æ¯”æ ¼å¼åŒ–ï¼šä¸é‹ç®—ï¼Œåƒ…ç›´æ¥åŠ  %ï¼›å·²å« % ç¶­æŒ ========== */
function toPercentString(val){
  if (val == null || val === '') return '';
  // æ­£è¦åŒ–ï¼šå…¨å½¢ï¼…â†’%ï¼Œå»æ‰å°¾ç«¯å¤šé¤˜ç©ºç™½èˆ‡æ—¢æœ‰çš„%
  let s = String(val).trim().replace(/ï¼…/g,'%');
  s = s.replace(/\s*%\s*$/,''); // è‹¥åŸæœ¬å°±æœ‰ %ï¼Œå…ˆç§»é™¤é¿å…é‡è¤‡
  return s + '%';
}

/* ========== ä¸»æµç¨‹ ========== */
startBtn.onclick = async () => {
  if (!workbook) { alert('è«‹å…ˆé¸æ“‡æª”æ¡ˆ'); return; }
  indicator.textContent = 'ğŸŸ¡';
  statusEl.textContent = 'åŸ·è¡Œä¸­...';
  errorBox.style.display = 'none';
  errItems.innerHTML = '';
  try {
    const ws  = workbook.Sheets[targetSheetName];
    const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
    if (!aoa.length) throw new Error('è¡¨æ ¼ç‚ºç©º');

    // 1) è‡ªå‹•åµæ¸¬è¡¨é ­åˆ—
    const hdr = detectHeaderRow(aoa);
    if (!hdr) throw new Error('æ‰¾ä¸åˆ°è¡¨é ­ï¼ˆéœ€å«ã€ŒåŸºé‡‘ä»£ç¢¼ã€ä¸”è‡³å°‘æœ‰ è¿‘1å¹´%/è¿‘3å¹´%/è¿‘5å¹´% ä»»ä¸€æ¬„ï¼‰');
    const headerRow = hdr.r;
    const idx = hdr.map;
    statusEl.textContent = `å·²å®šä½è¡¨é ­åˆ—ï¼šç¬¬ ${headerRow+1} åˆ—`;

    // debugï¼šé¡¯ç¤ºæ¬„ä½å°æ‡‰
    out.textContent =
      '[Header map] ' + JSON.stringify(idx) + '\n' +
      '[Headers] ' + JSON.stringify(aoa[headerRow]) + '\n';

    // 2) å»ºç«‹ funds æ¸…å–® + row map
    const funds = [];
    const rowMap = new Map();
    for (let r=headerRow+1; r<aoa.length; r++){
      const code = String(aoa[r]?.[idx.code] || '').trim();
      if (!code) continue;
      const name = String(aoa[r]?.[0] || '').trim();
      funds.push({ name: name || code, code });
      rowMap.set(code, r);
    }
    if (!funds.length) throw new Error('è³‡æ–™åˆ—ä¸­æ²’æœ‰ä»»ä½•åŸºé‡‘ä»£ç¢¼');

    // 3) å‘¼å«æ‰¹æ¬¡ API
    const resp = await fetch(ep.value.trim(), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ funds })
    });
    const data = await resp.json();
    if (!resp.ok) throw new Error('æ‰¹æ¬¡ API å¤±æ•—ï¼šHTTP ' + resp.status);

    // 4) è½‰æˆ code -> itemï¼ˆæ”¯æ´ webReturns èˆ‡ riskï¼‰
    const byCode = new Map();
    for (const it of (Array.isArray(data)?data:[])) {
      let code = '';
      try { code = new URL(it.source).searchParams.get('a') || ''; } catch {}
      if (!code) continue;
      const entry = {
        returns: it.returns || {},
        web3m: (it.webReturns && it.webReturns['3m']) ?? it.web3m,
        web6m: (it.webReturns && it.webReturns['6m']) ?? it.web6m,
        std: (it.risk && (it.risk.stddev_annual ?? it.risk.stddevAnnual))
             ?? it.stddev_annual ?? it.stddevAnnual,
        sharpe: (it.risk && it.risk.sharpe) ?? it.sharpe,
        beta: (it.risk && it.risk.beta) ?? it.beta
      };
      byCode.set(code, entry);
    }

    // 5) å¯«å›ï¼ˆå ±é…¬/å¹´åŒ–æ¨™æº–å·® â†’ ç›´æ¥åŠ  %ï¼›Sharpe/Beta ç›´æ¥æ•¸å­—ï¼‰
    const W = (row, col, val, addPercent = true) => {
      if (col < 0 || val == null || val === '') return false;
      aoa[row][col] = addPercent ? toPercentString(val) : val;
      return true;
    };

    let updated=0, missingList=[];
    for (const [code, rowIdx] of rowMap.entries()){
      const it = byCode.get(code);
      if (!it || (!it.returns && !it.web3m && !it.std && it.sharpe==null && it.beta==null)) {
        missingList.push(`${aoa[rowIdx][0]||''}ï¼ˆ${code}ï¼‰`); continue;
      }

      // æ—¢æœ‰å€é–“ï¼ˆå…¨éƒ¨ â†’ ç›´æ¥åŠ  %ï¼‰
      if (it.returns){
        W(rowIdx, idx.m3, it.returns['3m']);
        W(rowIdx, idx.m6, it.returns['6m']);
        W(rowIdx, idx.y1, it.returns['1y']);
        W(rowIdx, idx.y2, it.returns['2y']);
        W(rowIdx, idx.y3, it.returns['3y']);
        W(rowIdx, idx.y5, it.returns['5y']);
      }
      // ç¶²é  3m/6mï¼ˆç›´æ¥åŠ  %ï¼‰
      if (idx.m3w >= 0) W(rowIdx, idx.m3w, it.web3m);
      if (idx.m6w >= 0) W(rowIdx, idx.m6w, it.web6m);

      // é¢¨éšªæŒ‡æ¨™ï¼šå¹´åŒ–æ¨™æº–å·® â†’ ç›´æ¥åŠ  %ï¼›Sharpe/Beta â†’ æ•¸å­—
      if (idx.std    >= 0) W(rowIdx, idx.std,    it.std);
      if (idx.sharpe >= 0 && it.sharpe!=null) W(rowIdx, idx.sharpe, it.sharpe, false);
      if (idx.beta   >= 0 && it.beta!=null)   W(rowIdx, idx.beta,   it.beta,   false);

      updated++;
    }

    // 6) å›å¯«å·¥ä½œè¡¨
    workbook.Sheets[targetSheetName] = XLSX.utils.aoa_to_sheet(aoa);

    // é¡¯ç¤ºæ‘˜è¦ & éŒ¯èª¤æ¸…å–®
    out.textContent += '\n[Sample API data]\n' +
      JSON.stringify((Array.isArray(data)?data.slice(0,3):data), null, 2) + '\n...';
    if (missingList.length){ errorBox.style.display='block'; errItems.innerHTML = missingList.map(x=>`â€¢ ${x}`).join('<br>'); }

    // 7) å¾ŒçºŒå‹•ä½œï¼ˆä¸Šå‚³ï¼ä¸‹è¼‰ï¼‰
    const originalName = fileEl.files[0]?.name || 'åŸºé‡‘è³‡æ–™åº«.xlsx';
    const mode = getMode();

    if (mode === 'upload') {
      statusEl.textContent = `å·²æ›´æ–° ${updated} ç­†ï¼Œæº–å‚™ä¸Šå‚³â€¦`;
      const payload = {
        filename: originalName,
        contentBase64: workbookToBase64(workbook),
        mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      };
      const upResp = await fetch(uploadUrlEl.value.trim(), {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
      });
      const txt = await upResp.text();
      if (!upResp.ok) throw new Error('ä¸Šå‚³å¤±æ•—ï¼šHTTP '+upResp.status+'ï¼›'+txt);
      indicator.textContent = 'ğŸŸ¢';
      statusEl.textContent = `å®Œæˆï¼šæ›´æ–° ${updated} ç­†ï¼›${missingList.length ? 'æœ‰ '+missingList.length+' ç­†éŒ¯èª¤' : 'å…¨æ•¸æˆåŠŸ'}ï¼›å·²ä¸Šå‚³é›²ç«¯`;
    } else {
      XLSX.writeFile(workbook, originalName);
      indicator.textContent = 'ğŸŸ¢';
      statusEl.textContent = `å®Œæˆï¼šæ›´æ–° ${updated} ç­†ï¼›${missingList.length ? 'æœ‰ '+missingList.length+' ç­†éŒ¯èª¤' : 'å…¨æ•¸æˆåŠŸ'}ï¼›å·²ä¸‹è¼‰ Excel`;
    }
  } catch (e) {
    indicator.textContent = 'ğŸ”´';
    statusEl.textContent = 'éŒ¯èª¤ï¼š' + e.message;
    console.error(e);
  }
};

function workbookToBase64(wb){
  const ab = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  let binary = '', bytes = new Uint8Array(ab);
  for (let i=0;i<bytes.byteLength;i++) binary+=String.fromCharCode(bytes[i]);
  return btoa(binary);
}
</script>
</body>
</html>
