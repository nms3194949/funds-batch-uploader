<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8">
<title>更新基金資料庫（依代碼覆寫）</title>
<style>
:root {
  --deep: #0A1221;
  --gold: #C9A227;
  --gold-grad: linear-gradient(180deg, #EFD88A 0%, #C9A227 50%, #B8860B 100%);
  --muted: #9fb1cc;
  --error-bg: #401A1A;
  --error-text: #FFDADA;
}
body { background: var(--deep); color: #EDEFF5; font-family: system-ui, "Noto Sans TC", sans-serif; padding: 24px; line-height: 1.6; }
h2 { font-size: 26px; font-weight: 800; background: var(--gold-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 12px; }
label { display:block; margin-top:12px; font-weight:600; color:var(--muted); }
input, button, textarea { border-radius: 10px; border: 1px solid #22304a; background: #0f1626; color: #EDEFF5; }
button { padding: 10px 18px; font-weight: 700; border: none; background: var(--gold-grad); color: #05122b; cursor: pointer; transition: 0.3s; box-shadow: 0 3px 6px rgba(0,0,0,.3); }
button:hover { filter: brightness(1.1); transform: translateY(-1px); } button:active { transform: translateY(0); }
#indicator { display:inline-block; margin-left:10px; font-size:20px; vertical-align:middle; }
pre { white-space: pre-wrap; background:#111827; padding:12px; border-radius:8px; margin-top:16px; color:#B2F5EA; font-size:13px; }
#errorList { margin-top:16px; background:var(--error-bg); color:var(--error-text); padding:12px; border-radius:8px; display:none; }
.mode-wrap { margin: 10px 0 6px; }
.segs { display:inline-flex; gap:8px; padding:4px; background:#0f1626; border:1px solid #22304a; border-radius:12px; }
.segs label { margin:0; padding:8px 12px; border-radius:10px; cursor:pointer; color:#EDEFF5; border:1px solid transparent; user-select:none; }
.segs input { display:none; }
.segs input:checked + span { background: var(--gold-grad); color:#05122b; font-weight:800; border-color:transparent; box-shadow: 0 2px 6px rgba(0,0,0,.35) inset; }
</style>

<body>
<h2>更新基金資料庫（依代碼覆寫 3m/6m/1Y/2Y/3Y/5Y）</h2>

<p>上傳現有 <b>基金資料庫.xlsx</b> → 自動抓取更新（覆寫同代碼基金）。<br>
值寫入規則：若抓到的數值 <code>&gt;1</code> 視為百分比，寫入前會自動 <code>÷100</code>。</p>

<label>批次 API Endpoint</label>
<input id="ep" style="width:600px;padding:8px"
 value="https://momo-fund-worker.nms3194949.workers.dev/api/funds/batch">

<label>Apps Script 上傳網址</label>
<input id="uploadUrl" style="width:600px;padding:8px"
 value="https://script.google.com/macros/s/AKfycbx6P7zOVtOsM6BUOb1WBbO455i1hUIns_qp65WWwzZ08ohlDsa9WPhxkAa99eseymua/exec">

<div class="mode-wrap">
  <label style="margin-bottom:6px">更新完成後的動作</label>
  <div class="segs" id="modeSegs">
    <label><input type="radio" name="afterMode" value="upload" id="mUpload" checked><span>自動上傳到雲端</span></label>
    <label><input type="radio" name="afterMode" value="download" id="mDownload"><span>下載更新後 Excel</span></label>
  </div>
</div>

<input id="file" type="file" accept=".xlsx,.xls">
<span id="info" style="color:var(--muted)"></span><br><br>

<button id="start">開始抓取並更新</button>
<span id="indicator">⚫</span>
<span id="status" style="margin-left:10px;color:var(--muted)"></span>

<pre id="out"></pre>
<div id="errorList"><b>⚠️ 錯誤清單：</b><br><div id="errItems"></div></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
const fileEl = document.getElementById('file');
const infoEl = document.getElementById('info');
const startBtn = document.getElementById('start');
const out = document.getElementById('out');
const statusEl = document.getElementById('status');
const indicator = document.getElementById('indicator');
const errorBox = document.getElementById('errorList');
const errItems = document.getElementById('errItems');
const ep = document.getElementById('ep');
const uploadUrlEl = document.getElementById('uploadUrl');
const modeSegs = document.getElementById('modeSegs');

let workbook, targetSheetName;

/* ========== 記住選項 ========== */
const LS = { ep:'cfg_ep', upload:'cfg_upload', mode:'cfg_mode' };
[[ep,LS.ep],[uploadUrlEl,LS.upload]].forEach(([el,key])=>{
  const v = localStorage.getItem(key); if (v) el.value = v;
  el.addEventListener('change',()=>localStorage.setItem(key, el.value||''));
});
modeSegs.addEventListener('change',()=>localStorage.setItem(LS.mode,getMode()));
if (localStorage.getItem(LS.mode)==='download') document.getElementById('mDownload').checked=true;

fileEl.addEventListener('change', async (e) => {
  const f = e.target.files[0];
  if (!f) return;
  infoEl.textContent = `已選擇：${f.name}（${(f.size/1024).toFixed(1)} KB）`;
  const data = await f.arrayBuffer();
  workbook = XLSX.read(data, { type: 'array' });
  targetSheetName = workbook.SheetNames[0];
});

function getMode(){ return (document.querySelector('input[name="afterMode"]:checked')?.value)||'upload'; }

/* ========== 表頭偵測：彈性別名 + 多列掃描 ========== */
const COL_HEADERS = {
  code: ['基金代碼','代碼','code'],
  y1:   ['近1年%','近一年%','1年%','一年%','1y','1Y','近1年％'],
  y3:   ['近3年%','近三年%','3年%','三年%','3y','3Y','近3年％','近3年累積%','近三年累積%'],
  y5:   ['近5年%','近五年%','5年%','五年%','5y','5Y','近5年％','近5年累積%','近五年累積%'],
  m3:   ['近3月%','三個月%','3月%','近三個月%','3m','3M','近3月％'],
  m6:   ['近6月%','六個月%','6月%','近六個月%','6m','6M','近6月％'],
  y2:   ['近2年%','二年%','2年%','近兩年%','2y','2Y','近2年％']
};
const NORM = s => String(s||'').replace(/\s+/g,'').replace(/％/g,'%').toLowerCase();
function findHeaderIndex(headers, aliases){
  const set = new Set(aliases.map(NORM));
  for (let i=0;i<headers.length;i++) if (set.has(NORM(headers[i]))) return i;
  return -1;
}
function detectHeaderRow(aoa, maxScan=15){
  for (let r=0; r<Math.min(maxScan, aoa.length); r++){
    const row = aoa[r] || [];
    const code = findHeaderIndex(row, COL_HEADERS.code);
    const y1   = findHeaderIndex(row, COL_HEADERS.y1);
    const y3   = findHeaderIndex(row, COL_HEADERS.y3);
    const y5   = findHeaderIndex(row, COL_HEADERS.y5);
    if (code>=0 && (y1>=0 || y3>=0 || y5>=0)) {
      return { r, map:{ code, y1, y3, y5,
        m3: findHeaderIndex(row, COL_HEADERS.m3),
        m6: findHeaderIndex(row, COL_HEADERS.m6),
        y2: findHeaderIndex(row, COL_HEADERS.y2)
      }, headers: row };
    }
  }
  return null;
}

/* ========== 主流程 ========== */
startBtn.onclick = async () => {
  if (!workbook) { alert('請先選擇檔案'); return; }
  indicator.textContent = '🟡';
  statusEl.textContent = '執行中...';
  errorBox.style.display = 'none';
  errItems.innerHTML = '';
  try {
    const ws  = workbook.Sheets[targetSheetName];
    const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
    if (!aoa.length) throw new Error('表格為空');

    // 1) 自動偵測表頭列
    const hdr = detectHeaderRow(aoa);
    if (!hdr) throw new Error('找不到表頭（需含「基金代碼」且至少有 近1年%/近3年%/近5年% 任一欄）');
    const headerRow = hdr.r;
    const idx = hdr.map;
    statusEl.textContent = `已定位表頭列：第 ${headerRow+1} 列`;

    if (idx.y1<0 || idx.y3<0 || idx.y5<0) {
      // 三欄任缺也允許，但提醒
      console.warn('提醒：三個年度欄位有缺，將只覆寫找得到的欄位', idx);
    }

    // 2) 建立 funds 清單 + row map
    const funds = [];
    const rowMap = new Map();
    for (let r=headerRow+1; r<aoa.length; r++){
      const code = String(aoa[r]?.[idx.code] || '').trim();
      if (!code) continue;
      const name = String(aoa[r]?.[0] || '').trim();
      funds.push({ name: name || code, code });
      rowMap.set(code, r);
    }
    if (!funds.length) throw new Error('資料列中沒有任何基金代碼');

    // 3) 呼叫批次 API
    const resp = await fetch(ep.value.trim(), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ funds })
    });
    const data = await resp.json();
    if (!resp.ok) throw new Error('批次 API 失敗：HTTP ' + resp.status);

    // 4) 轉成 code -> item
    const byCode = new Map();
    for (const it of (Array.isArray(data)?data:[])) {
      let code = '';
      try { code = new URL(it.source).searchParams.get('a') || ''; } catch {}
      if (code) byCode.set(code, it);
    }

    // 5) 寫回（>1 視為百分比 → ÷100）
    const conv = v => (v==null||v==='') ? null : (Number(v)>1 ? Number(v)/100 : Number(v));
    let updated=0, missingList=[];
    for (const [code, rowIdx] of rowMap.entries()){
      const it = byCode.get(code);
      if (!it || !it.returns){ missingList.push(`${aoa[rowIdx][0]||''}（${code}）`); continue; }
      const W = (c,val)=>{ if (c>=0 && val!=null && Number.isFinite(Number(val))) aoa[rowIdx][c]=conv(val); };

      W(idx.m3, it.returns['3m']);
      W(idx.m6, it.returns['6m']);
      W(idx.y1, it.returns['1y']);
      W(idx.y2, it.returns['2y']);
      W(idx.y3, it.returns['3y']);
      W(idx.y5, it.returns['5y']);
      updated++;
    }

    // 6) 回寫工作表
    workbook.Sheets[targetSheetName] = XLSX.utils.aoa_to_sheet(aoa);

    // 顯示摘要 & 錯誤清單
    out.textContent = JSON.stringify((Array.isArray(data)?data.slice(0,5):data), null, 2) + '\n...';
    if (missingList.length){ errorBox.style.display='block'; errItems.innerHTML = missingList.map(x=>`• ${x}`).join('<br>'); }

    // 7) 後續動作（上傳／下載）
    const originalName = fileEl.files[0]?.name || '基金資料庫.xlsx';
    const mode = getMode();

    if (mode === 'upload') {
      statusEl.textContent = `已更新 ${updated} 筆，準備上傳…`;
      const payload = {
        filename: originalName,
        contentBase64: workbookToBase64(workbook),
        mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      };
      const upResp = await fetch(uploadUrlEl.value.trim(), {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
      });
      const txt = await upResp.text();
      if (!upResp.ok) throw new Error('上傳失敗：HTTP '+upResp.status+'；'+txt);
      indicator.textContent = '🟢';
      statusEl.textContent = `完成：更新 ${updated} 筆；${missingList.length ? '有 '+missingList.length+' 筆錯誤' : '全數成功'}；已上傳雲端`;
    } else {
      XLSX.writeFile(workbook, originalName);
      indicator.textContent = '🟢';
      statusEl.textContent = `完成：更新 ${updated} 筆；${missingList.length ? '有 '+missingList.length+' 筆錯誤' : '全數成功'}；已下載 Excel`;
    }
  } catch (e) {
    indicator.textContent = '🔴';
    statusEl.textContent = '錯誤：' + e.message;
    console.error(e);
  }
};

function workbookToBase64(wb){
  const ab = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  let binary = '', bytes = new Uint8Array(ab);
  for (let i=0;i<bytes.byteLength;i++) binary+=String.fromCharCode(bytes[i]);
  return btoa(binary);
}
</script>
</body>
</html>
